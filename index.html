<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Replenish Exploration</title>
    <!-- Main stylesheet for page layout and styles -->
    <link rel="stylesheet" href="style.css" />
    <!-- Leaflet CSS for the interactive map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet.draw CSS for drawing polygons on the map -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"
    />
    <style>
      .endpoint-summary {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 18px;
        font-size: 15px;
      }
      .endpoint-summary code {
        background: #e9ecef;
        border-radius: 3px;
        padding: 2px 5px;
      }
      #ndvi-fetch-btn {
        margin-top: 10px;
        background: #3498db;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 15px;
      }
      #ndvi-fetch-btn:disabled {
        background: #b2bec3;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Replenish Exploration</h1>
      <div class="endpoint-summary">
        <b>API Endpoints Used:</b><br />
        <ul>
          <li>
            <code>GET /collections</code> ‚Äì List available satellite imagery
            collections
          </li>
          <li>
            <code>GET /processes</code> ‚Äì List available processing functions
            (e.g., NDVI)
          </li>
          <li>
            <code>POST /result</code> ‚Äì Execute a process graph to calculate
            NDVI
          </li>
        </ul>
        <b>Docs:</b>
        <a href="https://earthengine.openeo.org/v1.0/" target="_blank"
          >openEO Earth Engine API</a
        >
      </div>
      <p>
        Select a parcel in Spain to explore boundaries, ownership, and NDVI
        trends.
      </p>
    </header>
    <main>
      <!-- Map container: where the interactive map will appear -->
      <div id="map"></div>
      <!-- Parcel Info Panel: shows details about the selected/drawn parcel -->
      <div class="parcel-info-container">
        <section id="parcel-info">
          <h2>Parcel Info</h2>
          <div id="parcel-details">Select a parcel to see details.</div>
        </section>
        <!-- NDVI Info Panel: will show NDVI chart and abandonment indicator -->
        <section id="ndvi-info">
          <h2>NDVI Trend</h2>
          <canvas id="ndvi-chart"></canvas>
          <div id="abandonment-indicator"></div>
          <button id="ndvi-fetch-btn" disabled>
            Fetch NDVI for Selected Parcel
          </button>
        </section>
      </div>
    </main>
    <footer>
      <h3>Project by Eliezer Nsengi</h3>
    </footer>
    <!-- Leaflet JS for the interactive map -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet.draw JS for drawing polygons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <!-- Chart.js for NDVI charting (not yet used) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@openeo/js-client@2/openeo.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/oidc-client@1/lib/oidc-client.min.js"></script>
    <script>
      const map = L.map("map").setView([40.4637, -3.7492], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);
      const drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);
      const drawControl = new L.Control.Draw({
        draw: {
          polygon: true,
          marker: false,
          polyline: false,
          rectangle: false,
          circle: false,
          circlemarker: false,
        },
        edit: {
          featureGroup: drawnItems,
        },
      });
      map.addControl(drawControl);

      let lastCoords = null;
      map.on(L.Draw.Event.CREATED, function (event) {
        const layer = event.layer;
        drawnItems.clearLayers();
        drawnItems.addLayer(layer);
        const coords = layer
          .getLatLngs()[0]
          .map((latlng) => [latlng.lat, latlng.lng]);
        lastCoords = coords;
        updateParcelInfo({ coordinates: coords });
        document.getElementById("ndvi-fetch-btn").disabled = false;
      });

      function updateParcelInfo(parcelData) {
        const details = document.getElementById("parcel-details");
        if (!parcelData || !parcelData.coordinates) {
          details.textContent = "Parcel info will appear here.";
          return;
        }
        let html =
          "<b>Coordinates:</b><br>" +
          parcelData.coordinates
            .map((c) => `Lat: ${c[0].toFixed(5)}, Lng: ${c[1].toFixed(5)}`)
            .join("<br>");
        if (parcelData.ownership) {
          html += `<br><b>Ownership:</b> ${parcelData.ownership}`;
        }
        details.innerHTML = html;
      }

      const EARTH_ENGINE_BASE_URL = "https://earthengine.openeo.org/v1.0";
      const EARTH_ENGINE_CREDENTIALS = "Z3JvdXAxOnRlc3QxMjM="; // Base64 encoded "group1:test123"
      let accessToken = null; // Will store the access token
      let tokenExpiry = null; // Will store the token expiration time

      // Check if current token is still valid
      function isTokenValid() {
        if (!accessToken || !tokenExpiry) return false;
        const now = Math.floor(Date.now() / 1000); // Current time in seconds
        return now < tokenExpiry;
      }

      // Get access token using Basic authentication (following openEO spec)
      async function getAccessToken() {
        try {
          console.log("üîë Getting access token from /credentials/basic...");
          const response = await fetch(
            `${EARTH_ENGINE_BASE_URL}/credentials/basic`,
            {
              method: "GET",
              headers: {
                Authorization: `Basic ${EARTH_ENGINE_CREDENTIALS}`,
              },
            }
          );

          if (response.ok) {
            const tokenData = await response.json();
            accessToken = tokenData.access_token;
            tokenExpiry = tokenData.access_token_valid_until;

            console.log("‚úÖ Access token obtained:", accessToken);
            console.log("Token expires at:", new Date(tokenExpiry * 1000));
            return true;
          } else {
            const errorText = await response.text();
            console.log(
              "‚ùå Failed to get access token:",
              response.status,
              errorText
            );
            return false;
          }
        } catch (error) {
          console.log("‚ùå Error getting access token:", error.message);
          return false;
        }
      }

      async function fetchNDVIFromOpenEO(coords) {
        if (!coords || coords.length < 3) return;

        // Get access token if we don't have one or if current token is expired
        if (!isTokenValid()) {
          console.log("üîÑ Token not valid, getting new access token...");
          const tokenSuccess = await getAccessToken();
          if (!tokenSuccess) {
            alert("Failed to get access token. Please try again.");
            return;
          }
        } else {
          console.log("‚úÖ Using existing valid token");
        }

        // Calculate bounding box
        const lats = coords.map((c) => c[0]);
        const lngs = coords.map((c) => c[1]);
        const bbox = {
          west: Math.min(...lngs),
          east: Math.max(...lngs),
          south: Math.min(...lats),
          north: Math.max(...lats),
        };

        // Build process graph
        const processGraph = {
          process_graph: {
            load: {
              process_id: "load_collection",
              arguments: {
                id: "COPERNICUS/S2_SR",
                spatial_extent: bbox,
                temporal_extent: ["2023-06-01", "2023-06-30"],
                bands: ["B04", "B08"],
              },
            },
            ndvi: {
              process_id: "ndvi",
              arguments: {
                data: { from_node: "load" },
                red: "B04",
                nir: "B08",
              },
            },
            reduce: {
              process_id: "reduce_dimension",
              arguments: {
                data: { from_node: "ndvi" },
                dimension: "t",
                reducer: {
                  process_graph: {
                    mean: {
                      process_id: "mean",
                      arguments: {
                        data: { from_parameter: "data" },
                      },
                    },
                  },
                },
              },
            },
            save: {
              process_id: "save_result",
              arguments: {
                data: { from_node: "reduce" },
                format: "JSON",
              },
              result: true,
            },
          },
        };

        // Call the API with Bearer token
        try {
          document.getElementById("ndvi-fetch-btn").textContent = "Fetching...";
          document.getElementById("ndvi-fetch-btn").disabled = true;

          const response = await fetch(`${EARTH_ENGINE_BASE_URL}/result`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer basic//${accessToken}`,
            },
            body: JSON.stringify(processGraph),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(
              `Failed: ${response.status} ${response.statusText}\nDetails: ${errorText}`
            );
          }

          const ndviData = await response.json();
          updateNDVIChart(ndviData);
        } catch (err) {
          alert("NDVI fetch failed: " + err.message);
          updateNDVIChart(undefined);
        } finally {
          document.getElementById("ndvi-fetch-btn").textContent =
            "Fetch NDVI for Selected Parcel";
          document.getElementById("ndvi-fetch-btn").disabled = false;
        }
      }

      // Chart update logic (same as before)
      function updateNDVIChart(ndviData) {
        const ctx = document.getElementById("ndvi-chart").getContext("2d");
        let value = undefined;
        if (typeof ndviData === "number") {
          value = ndviData;
        } else if (Array.isArray(ndviData)) {
          value = ndviData.find((v) => typeof v === "number");
        } else if (typeof ndviData === "object" && ndviData !== null) {
          if (typeof ndviData.ndvi === "number") {
            value = ndviData.ndvi;
          } else if (typeof ndviData.value === "number") {
            value = ndviData.value;
          } else if (Array.isArray(ndviData.data)) {
            value = ndviData.data.find((v) => typeof v === "number");
          } else {
            for (const v of Object.values(ndviData)) {
              if (typeof v === "number") {
                value = v;
                break;
              } else if (Array.isArray(v)) {
                const found = v.find((x) => typeof x === "number");
                if (typeof found === "number") {
                  value = found;
                  break;
                }
              }
            }
          }
        }
        if (window.ndviChart) window.ndviChart.destroy();
        window.ndviChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["NDVI"],
            datasets: [
              {
                label: "NDVI",
                data: [value],
                backgroundColor: "green",
              },
            ],
          },
          options: {
            scales: {
              y: { min: -1, max: 1 },
            },
          },
        });
        document.getElementById("abandonment-indicator").textContent =
          "NDVI value: " + (typeof value === "number" ? value : "No data");
      }

      // Test authentication function
      async function testAuth() {
        try {
          console.log("üîê Testing authentication...");

          // First get access token
          const tokenSuccess = await getAccessToken();
          if (!tokenSuccess) {
            console.log("‚ùå Failed to get access token");
            return false;
          }

          // Then test with Bearer token
          const response = await fetch(`${EARTH_ENGINE_BASE_URL}/`, {
            headers: {
              Authorization: `Bearer basic//${accessToken}`,
            },
          });

          console.log("Response status:", response.status, response.statusText);

          if (response.ok) {
            const data = await response.json();
            console.log("‚úÖ Authentication successful");
            console.log("API Version:", data.api_version);
            return true;
          } else {
            const errorText = await response.text();
            console.log("‚ùå Authentication failed:", response.status);
            console.log("Error details:", errorText);
            return false;
          }
        } catch (error) {
          console.log("‚ùå Authentication error:", error.message);
          console.log("Error type:", error.name);
          return false;
        }
      }

      // Button event
      document.getElementById("ndvi-fetch-btn").onclick = function () {
        if (lastCoords) {
          fetchNDVIFromOpenEO(lastCoords);
        }
      };
    </script>
  </body>
</html>
